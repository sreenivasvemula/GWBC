<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <!-- MOTW-DISABLED saved from url=(0014)about:internet -->
    <title>Configuring Credit Allocation</title>
    <link rel="StyleSheet" href="css/credit-handling-config_bc.css" type="text/css" media="all" />
    <link rel="StyleSheet" href="css/webworks.css" type="text/css" media="all" />
    <link rel="StyleSheet" href="css/css-guidewire-extra.css" type="text/css" media="all" />
    <script type="text/javascript" language="JavaScript1.2" src="wwhdata/common/context.js"></script>
    <script type="text/javascript" language="JavaScript1.2" src="wwhdata/common/towwhdir.js"></script>
    <script type="text/javascript" language="JavaScript1.2" src="wwhdata/common/wwhpagef.js"></script>
    <script type="text/javascript" language="JavaScript1.2">
      <!--
        var  WebWorksRootPath = "";
      // -->
    </script>
    <script type="text/javascript" language="JavaScript1.2">
      <!--
        // Set reference to top level help frame
        //
        var  WWHFrame = WWHGetWWHFrame("", true);
      // -->
    </script>
    <script type="text/javascript" language="JavaScript1.2" src="scripts/expand.js"></script>
    <!-- THE FOLLOWING IS A GUIDEWIRE STYLE DEFINITION FOR THE LINK TO THIS FEATURE -->
    <link rel="StyleSheet" href="css/css-guidewire-extra.css" type="text/css" media="all" />
    <!-- THE FOLLOWING IS A GUIDEWIRE GSCRIPT FUNCTION FOR THE LINK TO THIS FEATURE -->
    <script type="text/javascript">
function guidewire_selectall()
{
var text_val=eval("document.linktothisurlform.urlfield");
text_val.focus();
text_val.select();
}
</script>
  </head>
  <body onLoad="WWHUpdate();" onUnload="WWHUnload();" onKeyDown="WWHHandleKeyDown((document.all||document.getElementById||document.layers)?event:null);" onKeyPress="WWHHandleKeyPress((document.all||document.getElementById||document.layers)?event:null);" onKeyUp="WWHHandleKeyUp((document.all||document.getElementById||document.layers)?event:null);">
    <!-- THE FOLLOWING IS A GUIDEWIRE DIV FOR THE 'LINK TO THIS' FEATURE -->
    <div id="linkToThisPage" class="popup" style="display: none;">
      <div class="popupTitle">Link Directly to This Page 
           <a href="#" onclick="var thePopup = getElementById('linkToThisPage');thePopup.style.display='none';return false;"><img class="popupClosebox" src="wwhelp/wwhimpl/common/images/close.gif" /></a></div>
      <div style="padding:6px;">
        <div class="popupText" id="linkToThisPageBookmark">An error has occurred if you see this messsage.</div>
        <form name="linktothisurlform" method="post" action="" style="width:275px;margin:0px">
          <input type="text" class="popupURLText" id="linkToThisPageURL" name="urlfield" rows="1" cols="55" onClick="guidewire_selectall();" onFocus="guidewire_selectall();"></input>
        </form>
      </div>
    </div>
    <br />
    <div class="WebWorks_Breadcrumbs" style="text-align: left;">
      <span>BillingCenter Configuration Guide</span> : 
    <span class="WebWorks_Breadcrumbs" style="text-align: left;"><a class="WebWorks_Breadcrumb_Link" href="p-BillingCenter.html#1201949">Guidewire BillingCenter Configuration</a> : <a class="WebWorks_Breadcrumb_Link" href="credit-handling-config_bc.48.1.html#1201949">Configuring Credit Handling</a> : Configuring Credit Allocation</span></div>
    <hr align="left" />
    <blockquote>
      <h3 class="H1_-_Heading_1"><a name="1201949">Configuring Credit Allocation</a></h3>
      <div class="B_-_Body"><a name="1201950">BillingCenter allocates credits using the </a><span class="cv_-_computer_voice">DirectBillPayment</span> plugin. The base configuration calls the plugin method <span class="cv_-_computer_voice">allocateCredits</span> to validate the existence of a negative credit and positive invoice items eligible to receive the allocation. Then, based on the type of credit, the method calls the applicable <span class="cv_-_computer_voice">allocate</span> method to perform the allocation. The <span class="cv_-_computer_voice">DirectBillPayment</span> plugin method <span class="cv_-_computer_voice">allocateCredits</span> is described in <a href="javascript:WWHClickedPopup('integration', 'bc-plugins.13.30.html#3806453', '');" title="Direct Bill Payment Plugin">“Allocate Credits” in the </a><span class="bt_-_book_title"><a href="javascript:WWHClickedPopup('integration', 'bc-plugins.13.30.html#3806453', '');" title="Direct Bill Payment Plugin">Integration Guide</a></span>.</div>
      <div class="B_-_Body"><a name="1206864">Policy credits, such as return premium credits, are allocated based on the relevant handling scheme for the type of credit being processed. Each handling scheme implements an </a><span class="cv_-_computer_voice">allocate</span> method to perform the allocation. The <span class="cv_-_computer_voice">allocateCredits</span> method determines the appropriate handling scheme and calls the scheme’s <span class="cv_-_computer_voice">allocate</span> method.</div>
      <div class="B_-_Body"><a name="1207090">The base configuration can be customized by modifying the plugin method </a><span class="cv_-_computer_voice">allocateCredits</span> or by defining a new allocation method and associated <span class="cv_-_computer_voice">allocate</span> method.</div>
      <h4 class="H2_-_Heading_2"><a name="1167347">Defining a New Credit Allocation Method</a></h4>
      <div class="B_-_Body"><a name="1167133">To customize the allocation of policy credits, a new </a><span class="cv_-_computer_voice">allocate</span> method must be defined. Each handling scheme defines its own <span class="cv_-_computer_voice">allocate</span> method.</div>
      <div class="N_-_Note">
        <span class="n_-_note">Note: </span><a name="1208083">The </a><span class="cv_-_computer_voice">allocate</span> methods provided in the handling schemes of the base configuration must not be modified. Instead, create a new allocation method as described in this section. The source code from an existing <span class="cv_-_computer_voice">allocate</span> method can be copied into the new method to provide a foundation for further development.</div>
      <div class="B_-_Body"><a name="1167134">Adding an allocation method is a multi-step process:</a></div>
      <div class="LS_-_List_Start_outer" style="margin-left: 57pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="LS_-_List_Start_inner" style="width: 15pt; white-space: nowrap">
                <span class="ri_-_run_in_header">	1.	</span>
              </div>
            </td>
            <td width="100%">
              <div class="LS_-_List_Start_inner"><a name="1172235">Add a typecode for the new allocation method to the </a><span class="cv_-_computer_voice">ReturnPremiumAllocateMethod</span> typelist.</div>
            </td>
          </tr>
        </table>
      </div>
      <div class="LI_-_List_Item_outer" style="margin-left: 57pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="LI_-_List_Item_inner" style="width: 15pt; white-space: nowrap">
                <span class="ri_-_run_in_header">	2.	</span>
              </div>
            </td>
            <td width="100%">
              <div class="LI_-_List_Item_inner"><a name="1172236">Create a new allocation class that implements </a><span class="cv_-_computer_voice">ReturnPremiumAllocationStrategy</span>. The class requires the following property and method.</div>
            </td>
          </tr>
        </table>
      </div>
      <div class="BI2_-_Bullet_Item_002c_Level_2_outer" style="margin-left: 67pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="BI2_-_Bullet_Item_002c_Level_2_inner" style="width: 15pt; white-space: nowrap">
                <span class="bu_-_bullet">•	</span>
              </div>
            </td>
            <td width="100%">
              <div class="BI2_-_Bullet_Item_002c_Level_2_inner"><a name="1172237">A </a><span class="cv_-_computer_voice">TypeKey</span> property that returns the new typecode added to the <span class="cv_-_computer_voice">ReturnPremiumAllocateMethod</span> typelist.</div>
            </td>
          </tr>
        </table>
      </div>
      <div class="BI2_-_Bullet_Item_002c_Level_2_outer" style="margin-left: 67pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="BI2_-_Bullet_Item_002c_Level_2_inner" style="width: 15pt; white-space: nowrap">
                <span class="bu_-_bullet">•	</span>
              </div>
            </td>
            <td width="100%">
              <div class="BI2_-_Bullet_Item_002c_Level_2_inner"><a name="1166091">An </a><span class="cv_-_computer_voice">allocate</span> method that accepts a collection of invoice items and allocates the negative credit items to pay the positive items.</div>
            </td>
          </tr>
        </table>
      </div>
      <div class="LI_-_List_Item_outer" style="margin-left: 57pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="LI_-_List_Item_inner" style="width: 15pt; white-space: nowrap">
                <span class="ri_-_run_in_header">	3.	</span>
              </div>
            </td>
            <td width="100%">
              <div class="LI_-_List_Item_inner"><a name="1172056">Instantiate the allocation class so BillingCenter can access it and call its </a><span class="cv_-_computer_voice">allocate</span> method. This is achieved by appending an entry to the list of credit allocation strategies specified in the <span class="cv_-_computer_voice">LinkedImplementationLoaderImpl.returnPremiumAllocationStrategies</span> method.</div>
            </td>
          </tr>
        </table>
      </div>
      <div class="H3_-_Heading_3_outer" style="margin-left: 36pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <h5 class="H3_-_Heading_3_inner" style="width: 18pt; white-space: nowrap"></h5>
            </td>
            <td width="100%">
              <h5 class="H3_-_Heading_3_inner"><a name="1172065">Defining a New Credit Allocation Method: An Example</a></h5>
            </td>
          </tr>
        </table>
      </div>
      <div class="B_-_Body"><a name="1172084">In this example, allocation occurs </a><span class="cv_-_computer_voice">First&nbsp;to&nbsp;Last</span>. However, invoice items are grouped into two tiers based on their policy period. Items having the same policy period as the credit are paid first. Afterward, any remaining credit is allocated to items belonging to other policy periods. Items in each group are paid in a <span class="cv_-_computer_voice">First&nbsp;to&nbsp;Last</span> manner.</div>
      <div class="B_-_Body"><a name="1209724">To enable the </a><span class="cv_-_computer_voice">DirectBillPayment</span> plugin <span class="cv_-_computer_voice">allocateCredits</span> method to call the new allocation method, the following required steps are performed.</div>
      <h6 class="HS_-_Head_Sub"><a name="1172058">Add a typecode for the new allocation method</a></h6>
      <div class="B_-_Body"><a name="1172814">The </a><span class="cv_-_computer_voice">ReturnPremiumAllocateMethod</span> typelist must define a typecode for the new allocation method. The manner in which the typecode is defined depends on whether the typelist has already been extended.</div>
      <div class="BI_-_Bullet_Item_outer" style="margin-left: 57pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="BI_-_Bullet_Item_inner" style="width: 15pt; white-space: nowrap">
                <span class="bu_-_bullet">•	</span>
              </div>
            </td>
            <td width="100%">
              <div class="BI_-_Bullet_Item_inner"><a name="1209921">If this is the first extension to the </a><span class="cv_-_computer_voice">ReturnPremiumAllocateMethod</span> typelist:</div>
            </td>
          </tr>
        </table>
      </div>
      <div class="LS2_-_List_Start_002c_Level_2_outer" style="margin-left: 67pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="LS2_-_List_Start_002c_Level_2_inner" style="width: 15pt; white-space: nowrap">
                <span class="ri_-_run_in_header">	1.	</span>
              </div>
            </td>
            <td width="100%">
              <div class="LS2_-_List_Start_002c_Level_2_inner"><a name="1172824">In BillingCenter Studio, in the </a><span class="uis_-_UI_element_Studio">Project</span> window, navigate to <span class="uis_-_UI_element_Studio">configuration</span><span class="ui_-_UI_element"> → </span><span class="uis_-_UI_element_Studio">config</span><span class="ui_-_UI_element"> → </span><span class="uis_-_UI_element_Studio">Metadata</span><span class="ui_-_UI_element"> → </span><span class="uis_-_UI_element_Studio">Typelist</span>.</div>
            </td>
          </tr>
        </table>
      </div>
      <div class="LI2_-_List_Item_002c_Level_2_outer" style="margin-left: 67pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="LI2_-_List_Item_002c_Level_2_inner" style="width: 15pt; white-space: nowrap">
                <span class="ri_-_run_in_header">	2.	</span>
              </div>
            </td>
            <td width="100%">
              <div class="LI2_-_List_Item_002c_Level_2_inner"><a name="1172828">Right-click </a><span class="cv_-_computer_voice">ReturnPremiumAllocateMethod.tti </span>and choose <span class="uis_-_UI_element_Studio">New</span> → <span class="uis_-_UI_element_Studio">Typelist&nbsp;Extension</span> and then click <span class="uis_-_UI_element_Studio">OK</span>.</div>
            </td>
          </tr>
        </table>
      </div>
      <div class="LP2_-_List_Para_002c_Level_2"><a name="1171021">Studio creates </a><span class="cv_-_computer_voice">ReturnPremiumAllocateMethod.ttx</span> in <span class="uis_-_UI_element_Studio">configuration</span><span class="ui_-_UI_element"> → </span><span class="uis_-_UI_element_Studio">config</span><span class="ui_-_UI_element"> → </span><span class="uis_-_UI_element_Studio">Extensions</span><span class="ui_-_UI_element"> → </span><span class="uis_-_UI_element_Studio">Typelist</span> and opens it in the Typelist editor.</div>
      <div class="BI_-_Bullet_Item_outer" style="margin-left: 57pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="BI_-_Bullet_Item_inner" style="width: 15pt; white-space: nowrap">
                <span class="bu_-_bullet">•	</span>
              </div>
            </td>
            <td width="100%">
              <div class="BI_-_Bullet_Item_inner"><a name="1171127">If the </a><span class="cv_-_computer_voice">ReturnPremiumAllocateMethod</span> typelist has already been extended:</div>
            </td>
          </tr>
        </table>
      </div>
      <div class="LS2_-_List_Start_002c_Level_2_outer" style="margin-left: 67pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="LS2_-_List_Start_002c_Level_2_inner" style="width: 15pt; white-space: nowrap">
                <span class="ri_-_run_in_header">	1.	</span>
              </div>
            </td>
            <td width="100%">
              <div class="LS2_-_List_Start_002c_Level_2_inner"><a name="1171201">In BillingCenter Studio, in the </a><span class="uis_-_UI_element_Studio">Project</span> window, navigate to <span class="uis_-_UI_element_Studio">configuration</span><span class="ui_-_UI_element"> → </span><span class="uis_-_UI_element_Studio">config</span><span class="ui_-_UI_element"> → </span><span class="uis_-_UI_element_Studio">Extensions</span><span class="ui_-_UI_element"> → </span><span class="uis_-_UI_element_Studio">Typelist</span>.</div>
            </td>
          </tr>
        </table>
      </div>
      <div class="LI2_-_List_Item_002c_Level_2_outer" style="margin-left: 67pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="LI2_-_List_Item_002c_Level_2_inner" style="width: 15pt; white-space: nowrap">
                <span class="ri_-_run_in_header">	2.	</span>
              </div>
            </td>
            <td width="100%">
              <div class="LI2_-_List_Item_002c_Level_2_inner"><a name="1171277">Double-click </a><span class="cv_-_computer_voice">ReturnPremiumAllocateMethod.ttx </span>to open it in the Typelist editor.</div>
            </td>
          </tr>
        </table>
      </div>
      <div class="B_-_Body"><a name="1171288">Continue with the following steps to define the new typecode.</a></div>
      <div class="LI_-_List_Item_outer" style="margin-left: 57pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="LI_-_List_Item_inner" style="width: 15pt; white-space: nowrap">
                <span class="ri_-_run_in_header">	1.	</span>
              </div>
            </td>
            <td width="100%">
              <div class="LI_-_List_Item_inner"><a name="1171337">In </a><span class="cv_-_computer_voice">ReturnPremiumAllocateMethod.ttx</span>, right-click an existing typecode and choose <span class="uis_-_UI_element_Studio">Add&nbsp;new</span> → <span class="uis_-_UI_element_Studio">typecode</span>. </div>
            </td>
          </tr>
        </table>
      </div>
      <div class="LI_-_List_Item_outer" style="margin-left: 57pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="LI_-_List_Item_inner" style="width: 15pt; white-space: nowrap">
                <span class="ri_-_run_in_header">	2.	</span>
              </div>
            </td>
            <td width="100%">
              <div class="LI_-_List_Item_inner"><a name="1171443">Enter the following values for the new typecode:</a></div>
            </td>
          </tr>
        </table>
      </div>
      <div class="BI2_-_Bullet_Item_002c_Level_2_outer" style="margin-left: 67pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="BI2_-_Bullet_Item_002c_Level_2_inner" style="width: 15pt; white-space: nowrap">
                <span class="bu_-_bullet">•	</span>
              </div>
            </td>
            <td width="100%">
              <div class="BI2_-_Bullet_Item_002c_Level_2_inner"><span class="ri_-_run_in_header"><a name="1171444">code</a></span> – <span class="cv_-_computer_voice">PolicyPeriodFirst</span></div>
            </td>
          </tr>
        </table>
      </div>
      <div class="BI2_-_Bullet_Item_002c_Level_2_outer" style="margin-left: 67pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="BI2_-_Bullet_Item_002c_Level_2_inner" style="width: 15pt; white-space: nowrap">
                <span class="bu_-_bullet">•	</span>
              </div>
            </td>
            <td width="100%">
              <div class="BI2_-_Bullet_Item_002c_Level_2_inner"><span class="ri_-_run_in_header"><a name="1171445">name</a></span> – <span class="it_-_input_text">Policy Period First</span></div>
            </td>
          </tr>
        </table>
      </div>
      <div class="BI2_-_Bullet_Item_002c_Level_2_outer" style="margin-left: 67pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="BI2_-_Bullet_Item_002c_Level_2_inner" style="width: 15pt; white-space: nowrap">
                <span class="bu_-_bullet">•	</span>
              </div>
            </td>
            <td width="100%">
              <div class="BI2_-_Bullet_Item_002c_Level_2_inner"><span class="ri_-_run_in_header"><a name="1172225">desc</a></span> – <span class="it_-_input_text">Use first-to-last allocation. Distribute first to items in the same policy period as the credit item, then to remaining items.</span></div>
            </td>
          </tr>
        </table>
      </div>
      <div class="N_-_Note">
        <span class="n_-_note">Note: </span><a name="1172226">Adding or changing a typecode is a data model change, and therefore requires a restart of the application. </a></div>
      <h6 class="HS_-_Head_Sub"><a name="1172246">Create a class that implements the </a><span class="cv_-_computer_voice">ReturnPremiumAllocationStrategy</span> interface</h6>
      <div class="LS_-_List_Start_outer" style="margin-left: 57pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="LS_-_List_Start_inner" style="width: 15pt; white-space: nowrap">
                <span class="ri_-_run_in_header">	1.	</span>
              </div>
            </td>
            <td width="100%">
              <div class="LS_-_List_Start_inner"><a name="1172419">Create a class that implements </a><span class="cv_-_computer_voice">ReturnPremiumAllocationStrategy</span>.</div>
            </td>
          </tr>
        </table>
      </div>
      <div class="LP_-_List_Para"><a name="1172420">Name the new class </a><span class="cv_-_computer_voice">PolicyPeriodFirstReturnPremiumAllocationStrategy</span>. As a starting development foundation, load the source file that implements the <span class="cv_-_computer_voice">ProportionalReturnPremiumAllocation</span> class and copy the implementations of the <span class="cv_-_computer_voice">TypeKey</span> property and <span class="cv_-_computer_voice">allocate</span> method into the new class.</div>
      <div class="N_-_Note">
        <span class="n_-_note">Note: </span><a name="1176651">The new class will be registered by </a><span class="cv_-_computer_voice">LinkedImplementationLoaderImpl</span>, therefore it needs to be thread<span style="font-size: 9.0pt">‑safe.</span></div>
      <div class="LI_-_List_Item_outer" style="margin-left: 57pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="LI_-_List_Item_inner" style="width: 15pt; white-space: nowrap">
                <span class="ri_-_run_in_header">	2.	</span>
              </div>
            </td>
            <td width="100%">
              <div class="LI_-_List_Item_inner"><a name="1176652">Modify the </a><span class="cv_-_computer_voice">TypeKey</span> property of the new class so it returns the new typecode that was added to the <span class="cv_-_computer_voice">ReturnPremiumAllocateMethod</span> typelist.</div>
            </td>
          </tr>
        </table>
      </div>
      <div class="LI_-_List_Item_outer" style="margin-left: 57pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="LI_-_List_Item_inner" style="width: 15pt; white-space: nowrap">
                <span class="ri_-_run_in_header">	3.	</span>
              </div>
            </td>
            <td width="100%">
              <div class="LI_-_List_Item_inner"><a name="1172562">Modify the </a><span class="cv_-_computer_voice">allocate</span> method, as follows.</div>
            </td>
          </tr>
        </table>
      </div>
      <PRE class="CF_-_Code_First_Line"><a name="1172647">override function allocate(distItems: List &lt;BaseDistItem&gt;, amountToAllocate: AllocationPool) {</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1210980">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1210982">&nbsp;&nbsp;&nbsp;&nbsp;// Validate that the required negative credit and positive invoice items exist.</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172648">    if (distItems.Empty) {</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172649">      return</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172650">    }</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172651">    var targetDist = distItems[0].BaseDist</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172652">    Preconditions.checkArgument(distItems.where(\elt -&gt; elt.BaseDist != targetDist).size() == 0,</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172653">        "All dist items must belong to the same base dist.")</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172654">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172655">    var positiveDistItems = distItems.where(\distItem -&gt; distItem.InvoiceItem.Amount.IsPositive)</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172656">    if (positiveDistItems.Empty) {</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172657">      return</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172658">    }</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172659">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172660">    var negativeDistItems = distItems.where(\distItem -&gt; distItem.InvoiceItem.Amount.IsNegative)</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172661">    if (negativeDistItems.Empty) {</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172662">      return</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172663">    }</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172664">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172665">    // Get the policy period of the first credit item</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1210425">    var policyPeriod = negativeDistItems[0].PolicyPeriod</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1210426">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1210427">    // Get all the positive invoice items that have the same policy period as the credit item.</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1210563">&nbsp;&nbsp;&nbsp;&nbsp;// These items comprise the “preferred” group that will receive credit allocations first.</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172669">    var preferredPositiveDistItems = positiveDistItems.where( </a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1173406">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\ elt -&gt; elt.PolicyPeriod == policyPeriod)</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172670">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1210432">&nbsp;&nbsp;&nbsp;&nbsp;// Calculate the amount to allocate to preferred items</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172671">    var currency = distItems[0].Currency</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172672">    var amountNeededForPreferred = preferredPositiveDistItems.sum(currency,</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1173447">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\ elt -&gt; elt.GrossAmountOwed - elt.GrossAmountToApply)</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172674">    var amountAvailableForPreferred = amountNeededForPreferred.min(amountToAllocate.GrossAmount)</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1210509">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1210511">&nbsp;&nbsp;&nbsp;&nbsp;// Allocate credit to the preferred invoice items based on a First-to-Last allocation method</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172675">    new FirstToLastAllocationStrategy().allocate(</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1173605">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preferredPositiveDistItems, AllocationPool.withGross(amountAvailableForPreferred))</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172676">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1210755">&nbsp;&nbsp;&nbsp;&nbsp;// Calculate the amount necessary for the remaining items. If any credit remains, allocate it</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1210864">&nbsp;&nbsp;&nbsp;&nbsp;// to these “nonpreferred” items. Use a First-to-Last allocation method.</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172677">    var amountAvailableForNonPreferred = amountToAllocate.GrossAmount - amountAvailableForPreferred</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172678">    if (amountAvailableForNonPreferred.IsPositive) {</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172679">       positiveDistItems.removeAll(preferredPositiveDistItems)</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172680">       new FirstToLastAllocationStrategy().allocate(positiveDistItems,</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1173627">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AllocationPool.withGross(amountAvailableForNonPreferred))</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1172681">    }</a></PRE>
      <PRE class="CL_-_Code_Last_Line"><a name="1172635">}</a></PRE>
      <h6 class="HS_-_Head_Sub"><a name="1172892">Instantiate the new allocation class and enable BillingCenter access</a></h6>
      <div class="LS_-_List_Start_outer" style="margin-left: 57pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="LS_-_List_Start_inner" style="width: 15pt; white-space: nowrap">
                <span class="ri_-_run_in_header">	1.	</span>
              </div>
            </td>
            <td width="100%">
              <div class="LS_-_List_Start_inner"><a name="1172896">In BillingCenter Studio, in the </a><span class="uis_-_UI_element_Studio">Project</span> window, navigate to <span class="uis_-_UI_element_Studio">configuration</span><span class="ui_-_UI_element"> → </span><span class="uis_-_UI_element_Studio">gsrc</span> and then to <span class="cv_-_computer_voice">gw.plugin.system.dependency</span>. Double-click <span class="cv_-_computer_voice">LinkedImplementationLoaderImpl.gs </span>to open the editor.</div>
            </td>
          </tr>
        </table>
      </div>
      <div class="LI_-_List_Item_outer" style="margin-left: 57pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="LI_-_List_Item_inner" style="width: 15pt; white-space: nowrap">
                <span class="ri_-_run_in_header">	2.	</span>
              </div>
            </td>
            <td width="100%">
              <div class="LI_-_List_Item_inner"><a name="1172801">Find the </a><span class="cv_-_computer_voice">LinkedImplementationLoaderImpl.returnPremiumAllocationStrategies</span> method.</div>
            </td>
          </tr>
        </table>
      </div>
      <div class="LI_-_List_Item_outer" style="margin-left: 57pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="LI_-_List_Item_inner" style="width: 15pt; white-space: nowrap">
                <span class="ri_-_run_in_header">	3.	</span>
              </div>
            </td>
            <td width="100%">
              <div class="LI_-_List_Item_inner"><a name="1172989">To the end of the list of allocation strategies, append a call that instantiates the new allocation class, as shown below.</a></div>
            </td>
          </tr>
        </table>
      </div>
      <PRE class="CF_-_Code_First_Line"><a name="1173060">uses PolicyPeriodFirstReturnPremiumAllocationStrategy</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1176891">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1176835">override function returnPremiumAllocationStrategies() : Collection&lt;ReturnPremiumAllocationStrategy&gt; {</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1173061">      return {</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1173062">          new FirstToLastReturnPremiumAllocationStrategy(),</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1173063">          new LastToFirstReturnPremiumAllocationStrategy(),</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1173064">          new ProportionalReturnPremiumAllocationStrategy(),</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1173065">          new PolicyPeriodFirstReturnPremiumAllocationStrategy()</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1173089">      }</a></PRE>
      <PRE class="CL_-_Code_Last_Line"><a name="1173090">}</a></PRE>
      <div class="N_-_Note">
        <span class="n_-_note">Note: </span><a name="1176669">All classes registered by </a><span class="cv_-_computer_voice">LinkedImplementationLoaderImpl</span> must be thread‑safe.</div>
      <div class="LI_-_List_Item_outer" style="margin-left: 57pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="LI_-_List_Item_inner" style="width: 15pt; white-space: nowrap">
                <span class="ri_-_run_in_header">	4.	</span>
              </div>
            </td>
            <td width="100%">
              <div class="LI_-_List_Item_inner"><a name="1173148">Make and deploy the project.</a></div>
            </td>
          </tr>
        </table>
      </div>
      <div class="B_-_Body"><a name="1214531">&nbsp;</a></div>
      <script type="text/javascript" language="JavaScript1.2">
        <!--
          // Clear related topics
          //
          WWHClearRelatedTopics();

          document.writeln(WWHRelatedTopicsInlineHTML());
        // -->
      </script>
    </blockquote>
    <script type="text/javascript" language="JavaScript1.2">
      <!--
        document.write(WWHRelatedTopicsDivTag() + WWHPopupDivTag() + WWHALinksDivTag());
      // -->
    </script>
  </body>
</html>